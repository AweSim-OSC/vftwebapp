#!/bin/bash

# Turn off screensaver
gconftool-2 --set -t boolean /apps/gnome-screensaver/idle_activation_enabled false

# Use browser window instead in nautilus
gconftool-2 --set -t boolean /apps/nautilus/preferences/always_use_browser true

. /etc/profile.d/lmod.sh

###########################################################################
# Preserve library paths -                                                #
# These get wiped probably because a binary with setuid or setgid bit was #
# called during the startup of gnome                                      #
###########################################################################
export VNC_OAKLEY_DESKTOP_LLP="${LD_LIBRARY_PATH}"
if [ ! -f "${HOME}/.bashrc" ]; then
    touch ${HOME}/.bashrc
fi
if [ ! -f "${HOME}/.bashrc_awesim" ]; then
    touch ${HOME}/.bashrc_awesim
fi

# Source our .bashrc_awesim
if ! grep -Fq "bashrc_awesim" ${HOME}/.bashrc
then
    echo '. ${HOME}/.bashrc_awesim' >> ${HOME}/.bashrc
fi

# Remove script from user's .bashrc if already exists
sed -i '/###VNC_OAKLEY_DESKTOP_BEGIN###/,/###VNC_OAKLEY_DESKTOP_END###/d' ${HOME}/.bashrc_awesim

# Add this to user's .bashrc
cat <<EOF >> ${HOME}/.bashrc_awesim
###VNC_OAKLEY_DESKTOP_BEGIN###
if [ -n "\${VNC_OAKLEY_DESKTOP_LLP}" ]; then
    export LD_LIBRARY_PATH="\${VNC_OAKLEY_DESKTOP_LLP}"
    export -n VNC_OAKLEY_DESKTOP_LLP
    unset VNC_OAKLEY_DESKTOP_LLP
    # Replace bash "module" functions that were lost
    . /usr/local/lmod/lmod/init/sh
fi
###VNC_OAKLEY_DESKTOP_END###
EOF
###########################################################################

# Start up Gnome desktop
/etc/X11/xinit/xinitrc

# Kill vncserver when user logs out of Gnome desktop
vncserver -kill $DISPLAY
